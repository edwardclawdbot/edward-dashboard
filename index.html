<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Edward's Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; font-size: 2.5em; }
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .status-item {
            background: rgba(255,255,255,0.1);
            padding: 15px 30px;
            border-radius: 10px;
            text-align: center;
        }
        .status-item .label { font-size: 0.9em; opacity: 0.7; }
        .status-item .value { font-size: 1.5em; font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 { 
            margin-bottom: 15px; 
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .task-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .task-item:hover { background: rgba(255,255,255,0.1); }
        .task-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .task-title { flex: 1; }
        .task-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .task-notes {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.5;
        }
        .task-notes.show { display: block; }
        .expand-icon {
            transition: transform 0.2s;
            font-size: 0.8em;
        }
        .task-item.expanded .expand-icon { transform: rotate(90deg); }
        .status-working { background: #f39c12; color: #000; }
        .status-queue { background: #3498db; }
        .status-todo { background: #9b59b6; }
        .status-done { background: #27ae60; }
        .emoji { font-size: 1.2em; }
        .timestamp { 
            font-size: 0.8em; 
            opacity: 0.5; 
            margin-left: auto;
        }
        #current-task {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
        }
        #current-task h2 { border-bottom-color: rgba(255,255,255,0.2); }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .active-indicator {
            width: 10px;
            height: 10px;
            background: #27ae60;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .idle-indicator { background: #7f8c8d; animation: none; }
        #last-updated {
            text-align: center;
            margin-top: 30px;
            opacity: 0.7;
            font-size: 0.9em;
        }
        #activity-time { color: #f39c12; font-weight: bold; }
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .quick-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            color: #fff;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .quick-btn:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Edward's Dashboard</h1>
        
        <div class="quick-actions">
            <button class="quick-btn" onclick="setStatus('üíª Coding')">üíª Coding</button>
            <button class="quick-btn" onclick="setStatus('üîß Setting Up')">üîß Setting Up</button>
            <button class="quick-btn" onclick="setStatus('üìñ Reading')">üìñ Reading</button>
            <button class="quick-btn" onclick="setStatus('‚òï Break')">‚òï Break</button>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="label">Status</div>
                <div class="value" id="status-indicator">
                    <span class="active-indicator"></span> Active
                </div>
            </div>
            <div class="status-item">
                <div class="label">Tasks</div>
                <div class="value" id="task-count">-</div>
            </div>
            <div class="status-item">
                <div class="label">Location</div>
                <div class="value">Kali Linux</div>
            </div>
            <div class="status-item">
                <div class="label">Last Activity</div>
                <div class="value" id="activity-time">-</div>
            </div>
        </div>

        <div class="grid">
            <div class="card" id="current-task">
                <h2>üî• Currently Working On</h2>
                <div id="working-content">Loading...</div>
            </div>
            
            <div class="card">
                <h2>üìã To-Do (click to expand)</h2>
                <div id="todo-content">Loading...</div>
            </div>
            
            <div class="card">
                <h2>‚è≥ In Queue</h2>
                <div id="queue-content">Loading...</div>
            </div>
            
            <div class="card">
                <h2>‚úÖ Recently Completed</h2>
                <div id="done-content">Loading...</div>
            </div>
            
            <div class="card" style="border-color: #3498db;">
                <h2>üéÅ Requests <span style="font-size: 0.7em; opacity: 0.6;">- Skills awaiting approval</span></h2>
                <div id="requests-content">Loading...</div>
            </div>
        </div>

        <div id="last-updated">
            Last updated: <span id="update-time">-</span> | 
            Status auto-updates in real-time via SSE
        </div>
    </div>

    <script>
        let eventSource = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        function connectSSE() {
            eventSource = new EventSource('/stream');
            
            eventSource.onopen = () => {
                console.log('SSE connected');
                reconnectAttempts = 0;
            };
            
            eventSource.onmessage = (e) => {
                try {
                    const data = JSON.parse(e.data);
                    updateDashboard(data);
                } catch (err) {
                    console.error('Parse error:', err);
                }
            };
            
            eventSource.onerror = () => {
                console.log('SSE error, reconnecting...');
                eventSource.close();
                reconnectAttempts++;
                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(connectSSE, 3000);
                }
            };
        }
        
        function toggleNotes(id) {
            const notes = document.getElementById(id);
            const item = notes.closest('.task-item');
            notes.classList.toggle('show');
            item.classList.toggle('expanded');
        }
        
        async function setStatus(status) {
            try {
                await fetch('/api/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        working: { title: status, detail: 'Manual status set' }
                    })
                });
                console.log('Status updated:', status);
            } catch (e) {
                console.error('Failed to update status:', e);
            }
        }
        
        function updateDashboard(data) {
            if (data.working) {
                document.getElementById('working-content').innerHTML = `
                    <div class="task-item" style="background: rgba(0,0,0,0.2);">
                        <div class="task-header">
                            <span class="emoji">üéØ</span>
                            <span class="task-title">${data.working.title}</span>
                            <span class="timestamp">${data.working.detail || ''}</span>
                        </div>
                    </div>
                `;
            }
            
            if (data.lastActivity) {
                const time = new Date(data.lastActivity);
                document.getElementById('activity-time').textContent = time.toLocaleTimeString();
            }
            
            const statusEl = document.getElementById('status-indicator');
            if (data.lastActivity) {
                const diff = Date.now() - new Date(data.lastActivity).getTime();
                if (diff < 60000) {
                    statusEl.innerHTML = '<span class="active-indicator"></span> Active';
                } else if (diff < 300000) {
                    statusEl.innerHTML = '<span class="active-indicator idle-indicator"></span> Recent';
                } else {
                    statusEl.innerHTML = '<span class="active-indicator idle-indicator"></span> Idle';
                }
            }
            
            document.getElementById('update-time').textContent = new Date().toLocaleString();
            loadTasks();
        }
        
        async function loadTasks() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                const tasksRes = await fetch('/tasks.json');
                const tasks = await tasksRes.json();
                
                // Todo with expandable notes
                document.getElementById('todo-content').innerHTML = (tasks.todo || []).map((task, i) => `
                    <div class="task-item" onclick="toggleNotes('todo-notes-${i}')">
                        <div class="task-header">
                            <span class="expand-icon">‚ñ∂</span>
                            <span class="emoji">üìù</span>
                            <span class="task-title">${task.title}</span>
                            <span class="task-badge status-todo">${task.priority}</span>
                        </div>
                        ${task.notes ? `<div class="task-notes" id="todo-notes-${i}">${task.notes}</div>` : ''}
                    </div>
                `).join('') || '<div class="task-item">No tasks</div>';
                
                // Queue with expandable notes
                document.getElementById('queue-content').innerHTML = (tasks.queue || []).map((task, i) => `
                    <div class="task-item" onclick="toggleNotes('queue-notes-${i}')">
                        <div class="task-header">
                            <span class="expand-icon">‚ñ∂</span>
                            <span class="emoji">‚è∏Ô∏è</span>
                            <span class="task-title">${task.title}</span>
                            <span class="task-badge status-queue">${task.priority}</span>
                        </div>
                        ${task.notes ? `<div class="task-notes" id="queue-notes-${i}">${task.notes}</div>` : ''}
                    </div>
                `).join('') || '<div class="task-item">Nothing in queue</div>';
                
                // Done
                document.getElementById('done-content').innerHTML = (tasks.done || []).map(task => `
                    <div class="task-item">
                        <div class="task-header">
                            <span class="emoji">‚úÖ</span>
                            <span class="task-title">${task.title}</span>
                            <span class="timestamp">${task.time}</span>
                        </div>
                    </div>
                `).join('') || '<div class="task-item">Nothing done yet</div>';
                
                // Requests
                document.getElementById('requests-content').innerHTML = (tasks.requests || []).map(req => `
                    <div class="task-item" onclick="toggleNotes('req-notes-${req.id}')" style="border-left: 3px solid #3498db;">
                        <div class="task-header">
                            <span class="expand-icon">‚ñ∂</span>
                            <span class="emoji">${req.emoji}</span>
                            <span class="task-title">${req.skill}</span>
                            <span class="task-badge status-queue">${req.status}</span>
                        </div>
                        ${req.reason ? `<div class="task-notes" id="req-notes-${req.id}">
                            <strong>Why:</strong> ${req.reason}<br><br>
                            <strong>Install:</strong> <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">${req.install}</code><br><br>
                            ${req.notes ? `<strong>Notes:</strong> ${req.notes}<br><br>` : ''}
                            <strong>Safe:</strong> ${req.safe ? '‚úÖ Yes' : '‚ö†Ô∏è Review needed'}
                        </div>` : ''}
                    </div>
                `).join('') || '<div class="task-item">No pending requests</div>';
                
                const total = (tasks.todo || []).length + (tasks.queue || []).length;
                document.getElementById('task-count').textContent = total;
                
            } catch (e) {
                console.error('Error loading tasks:', e);
            }
        }
        
        connectSSE();
        setInterval(loadTasks, 30000);
        loadTasks();
    </script>
</body>
</html>
